Description: 'An AWS elasticsearch service custom resource implementation'

Metadata:
    Version: 0.1

Parameters:
- DomainName:
    Type: String
- InstanceType:
    Type: String
    Default: t2.micro.elasticsearch
    AllowedValues:
        - t2.micro.elasticsearch
        - t2.small.elasticsearch
        - t2.medium.elasticsearch
        - m3.medium.elasticsearch
        - m3.large.elasticsearch
        - m3.xlarge.elasticsearch
        - m3.2xlarge.elasticsearch
        - r3.large.elasticsearch
        - r3.xlarge.elasticsearch
        - r3.2xlarge.elasticsearch
        - r3.4xlarge.elasticsearch
        - r3.8xlarge.elasticsearch
        - i2.xlarge.elasticsearch
        - i2.2xlarge.elasticsearch
- InstanceCount:
    Type: Number
    Default: '1'
- DedicatedMasterEnabled:
    Type: String
    Default: 'False'
    AllowedValues:
        - 'True'
        - 'False'
- DedicatedMasterCount:
    Type: Number
    Default: '1'
- DedicatedMasterType:
    Type: String
    Default: t2.micro.elasticsearch
    AllowedValues:
        - t2.micro.elasticsearch
        - t2.small.elasticsearch
        - t2.medium.elasticsearch
        - m3.medium.elasticsearch
        - m3.large.elasticsearch
        - m3.xlarge.elasticsearch
        - m3.2xlarge.elasticsearch
        - r3.large.elasticsearch
        - r3.xlarge.elasticsearch
        - r3.2xlarge.elasticsearch
        - r3.4xlarge.elasticsearch
        - r3.8xlarge.elasticsearch
        - i2.xlarge.elasticsearch
        - i2.2xlarge.elasticsearch
- ZoneAwarenessEnabled:
    Type: String
    Default: 'False'
    AllowedValues:
        - 'True'
        - 'False'
- EBSEnabled:
    Type: String
    Default: 'False'
    AllowedValues:
        - 'True'
        - 'False'
- VolumeType:
    Type: String
    Default: standard
    AllowedValues: 
        - standard
        - gp2
        - io1
- VolumeSize:
    Type: String
    Default: '0'
- Iops:
    Type: Number
    Default: '0'
- AccessPolicies:
    Type: String
    Default: 'False'
- AutomatedSnapshotStartHour:
    Type: Number
    Default: '0'
- RestActionMultiAllowExplicitIndex:
    Type: String
    Default: 'True'
- IndicesFielddataCacheSize:
    Type: Number
    Default: '-1'


Conditions:
- ConditionDedicatedMasterEnabled: !Equals [ !Ref DedicatedMasterEnabled, True ]
- ConditionEbsEnabled: !Equals [ !Ref EBSEnabled, True ]
- ConditionVolumeTypeIo1: !Equals [ !Ref VolumeType, io1 ]
- ConditionAccessPolicies: !Not [ !Equals [ !Ref AccessPolicies, False ] ]
- ConditionIndicesFielddataCacheSize: !Not [ !Equals [ !Ref IndicesFielddataCacheSize, '-1' ] ]

Resources:
- LogsPolicy:
    Type: iam.Policy
    Properties:
        PolicyName: LogsPolicy
        PolicyDocument:
            Statement:
                - Effect: Allow
                  Action:
                    - 'logs:CreateLogGroup'
                    - 'logs:CreateLogStream'
                    - 'logs:PutLogEvents'
                  Resource: 'arn:aws:logs:*:*:*'

- ElasticsearchPolicy:
    Type: iam.Policy
    Properties:
        PolicyName: root
        PolicyDocument:
            Statement:
                - Effect: Allow
                  Action:
                    - 'es:*'
                  Resource: 'arn:aws:es:*:*:*'

- LambdaExecutionRole:
    Type: iam.Role
    Properties:
        AssumeRolePolicyDocument:
            Statement:
                - Effect: Allow
                  Principal:
                    Service:
                        - lambda.amazonaws.com
                  Action:
                      - 'sts:AssumeRole'
        Path: '/'
        Policies:
            - !Ref LogsPolicy
            - !Ref ElasticsearchPolicy

- LambdaCustomResourceElasticsearch:
    Type: awslambda.Function
    Properties:
        Handler: 'es.lambda_handler'
        Role: !GetAtt [ LambdaExecutionRole, Arn ]
        Code:
            S3Bucket: elelsee-lambda
            S3Key: 'customresource-aws-es/es.zip'
        Runtime: python2.7
        Timeout: 300

- ElasticsearchDomain:
      Type: custom.ElasticsearchDomain
      Properties:
        ServiceToken: !GetAtt [ LambdaCustomResourceElasticsearch, Arn ]
        DomainName: !Ref DomainName
        ElasticsearchClusterConfig:
            InstanceType: !Ref InstanceType
            InstanceCount: !Ref InstanceCount
            DedicatedMasterEnabled: !Ref DedicatedMasterEnabled
            DedicatedMasterType: !If [ ConditionDedicatedMasterEnabled, !Ref DedicatedMasterType, !NoValue ]
            DedicatedMasterCount: !If [ ConditionDedicatedMasterEnabled, !Ref DedicatedMasterCount, !NoValue ]
            ZoneAwarenessEnabled: !Ref ZoneAwarenessEnabled
        EBSOptions:
            EBSEnabled: !Ref EBSEnabled
            VolumeType: !If [ ConditionEbsEnabled, !Ref VolumeType, !NoValue ]
            VolumeSize: !If [ ConditionEbsEnabled, !Ref VolumeSize, !NoValue ]
            Iops: !If [ ConditionVolumeTypeIo1, !Ref Iops, !NoValue ]
        AccessPolicies: !If [ ConditionAccessPolicies, !Ref AccessPolicies, !NoValue ]
        SnapshotOptions:
            AutomatedSnapshotStartHour: !Ref AutomatedSnapshotStartHour
        AdvancedOptions: 
            rest.action.multi.allow_explicit: !Ref RestActionMultiAllowExplicitIndex
            indices.fielddata.cache.size: !If [ ConditionIndicesFielddataCacheSize, !Ref IndicesFielddataCacheSize, !NoValue ]

